name: frontend-dev-deploy

on:
  push:
    branches:
      - develop
    paths:
      - 'client/**'

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Source
        uses: actions/checkout@v5

      - name: Setup Node.js
        uses: actions/setup-node@v5
        with:
          node-version: '22.16.0'
          # cache: 'yarn' # act í…ŒìŠ¤íŠ¸ ì‹œ ì£¼ì„ ì²˜ë¦¬

      # act í…ŒìŠ¤íŠ¸ì‹œì—ë§Œ yarn ì„¤ì¹˜
      - name: Install Yarn
        run: npm install yarn

      - name: Install Dependencies & Build
        working-directory: ./client
        env:
          NEXT_PUBLIC_CDN_DOMAIN: ${{ secrets.NEXT_PUBLIC_CDN_DOMAIN }}
          VIEW_DATA_FILE_PATH: ${{ secrets.VIEW_DATA_FILE_PATH }}
          VIEW_DATA_FLUSH_THRESHOLD: ${{ secrets.VIEW_DATA_FLUSH_THRESHOLD }}
          NEXT_PUBLIC_BACKEND_SERVER_BASE_URL: ${{ secrets.NEXT_PUBLIC_BACKEND_SERVER_BASE_URL }}
          NEXT_PUBLIC_FRONTEND_SERVER_BASE_URL: ${{ secrets.NEXT_PUBLIC_FRONTEND_SERVER_BASE_URL }}
          NEXT_PUBLIC_AMPLITUDE_API_KEY: ${{ secrets.NEXT_PUBLIC_AMPLITUDE_API_KEY }}
          NEXT_PUBLIC_IMAGE_S3_DOMAIN: ${{ secrets.NEXT_PUBLIC_IMAGE_S3_DOMAIN }}
          NEXT_PUBLIC_IMAGE_CLOUDFRONT_DOMAIN: ${{ secrets.NEXT_PUBLIC_IMAGE_CLOUDFRONT_DOMAIN }}
          NEXT_PUBLIC_SENTRY_DSN: ${{ secrets.NEXT_PUBLIC_SENTRY_DSN }}
          SENTRY_AUTH_TOKEN: ${{ secrets.SENTRY_AUTH_TOKEN }}
        run: |
          echo "ğŸš§ Installing dependencies..."
          yarn install --frozen-lockfile

          echo "ğŸ—ï¸ Building Next.js..."
          yarn build

      - name: Compress Build Output Only
        working-directory: ./client
        run: |
          echo "ğŸ“¦ Compressing .next..."
          tar -czf next-build.tar.gz .next

      - name: Transfer Build to Dev Server
        working-directory: ./client
        run: |
          echo "ğŸ”‘ Setting up SSH key..."
          printf "%s\n" "${{ secrets.SSH_DEV_KEY }}" > private_key.pem
          sed -i 's/\r$//' private_key.pem
          chmod 600 private_key.pem

          echo "ğŸš€ Sending .next build via SCP..."
          scp -o StrictHostKeyChecking=no -i private_key.pem -P ${{ secrets.SSH_DEV_PORT }} \
            next-build.tar.gz \
            ${{ secrets.SSH_DEV_USERNAME }}@${{ secrets.SSH_DEV_HOST }}:${{ secrets.EC2_DEV_DEPLOY_DIR }}

          echo "ğŸ§¹ Cleaning up..."
          rm private_key.pem

      - name: Deploy on EC2
        working-directory: ./client
        run: |
          echo "ğŸ”‘ Setting up SSH key..."
          printf "%s\n" "${{ secrets.SSH_DEV_KEY }}" > private_key.pem
          sed -i 's/\r$//' private_key.pem
          chmod 600 private_key.pem

          echo "ğŸ“œ Creating deployment script..."
          cat <<'EOF' > deploy_script.sh
            # ë””ë²„ê¹… í™˜ê²½ ì •ë³´ ì¶œë ¥
            echo "=== í™˜ê²½ ì •ë³´ ==="
            echo "í˜„ì¬ ì‚¬ìš©ì: $(whoami)"
            echo "í™ˆ ë””ë ‰í† ë¦¬: $HOME"
            echo "Node ë²„ì „: $(node --version 2>/dev/null || echo 'Node ì—†ìŒ')"
            echo "Yarn ê²½ë¡œ: $(which yarn 2>/dev/null || echo 'Yarn ì—†ìŒ')"
            echo "PM2 ê²½ë¡œ: $(which pm2 2>/dev/null || echo 'PM2 ì—†ìŒ')"
            echo "=================="

            # ë°°í¬ ë””ë ‰í† ë¦¬ë¡œ ì´ë™ ë° ì¡´ì¬ í™•ì¸
            cd ${{ secrets.EC2_DEV_DEPLOY_DIR }} || {
              echo "âŒ ë°°í¬ ë””ë ‰í† ë¦¬ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ${{ secrets.EC2_DEV_DEPLOY_DIR }}"
              exit 1
            }
            echo "ğŸ“ í˜„ì¬ ìœ„ì¹˜: $(pwd)"

            echo "ğŸ”„ Pulling latest code from Git..."
            # git ì¶©ëŒ ë°©ì§€ë¥¼ ìœ„í•œ ê°•ì œ ë®ì–´ì“°ê¸°
            git fetch origin develop
            git reset --hard origin/develop
            
            echo "ğŸ“‚ Extracting .next build..."
            rm -rf .next
            tar -xzf next-build.tar.gz
            rm next-build.tar.gz

            echo "ğŸ“¥ Setting up Node environment..."
            export NVM_DIR="$HOME/.nvm"
            [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
            nvm use 22.16.0

            if ! command -v yarn &> /dev/null; then
              echo "âš ï¸  yarnì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. npmìœ¼ë¡œ yarn ì„¤ì¹˜ ì¤‘..."
              npm install -g yarn
            fi
            
            yarn install --frozen-lockfile

            echo "ğŸš€ Checking PM2..."
            if ! command -v yarn &> /dev/null; then
              echo "âš ï¸  yarnì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. npmìœ¼ë¡œ yarn ì„¤ì¹˜ ì¤‘..."
              npm install -g yarn
            fi

            echo "ğŸš€ Restarting PM2..."
            pm2 reload ecosystem.config.js --env development --update-env
            
            echo "âœ… Deployment Complete!"
          EOF

          echo "ğŸš€ Executing deployment on EC2..."
          ssh -o StrictHostKeyChecking=no -i private_key.pem -p ${{ secrets.SSH_DEV_PORT }} \
            ${{ secrets.SSH_DEV_USERNAME }}@${{ secrets.SSH_DEV_HOST }} \
            "bash -s" < deploy_script.sh

          echo "ğŸ§¹ Cleaning up..."
          rm private_key.pem deploy_script.sh
      # [Act ì „ìš©] ë¹Œë“œ ê²°ê³¼ í™•ì¸ ë‹¨ê³„
      - name: Verify Build (Act Test)
        if: env.ACT # act í™˜ê²½ì—ì„œë§Œ ì‹¤í–‰
        working-directory: ./client
        run: |
          echo "âœ… Act í…ŒìŠ¤íŠ¸ ì™„ë£Œ!"
          echo "ğŸ“¦ ë¹Œë“œ íŒŒì¼ í™•ì¸:"
          ls -lh next-build.tar.gz
          echo ""
          echo "ğŸ“ .next ë””ë ‰í† ë¦¬ êµ¬ì¡°:"
          tar -tzf next-build.tar.gz | head -20
