name: frontend-dev-deploy

on:
  push:
    branches:
      - develop

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: development

    steps:
      - name: Checkout Source
        uses: actions/checkout@v5

      - name: Setup Node.js
        uses: actions/setup-node@v5
        with:
          node-version: '22.16.0'
          cache: 'yarn'
          cache-dependency-path: './client/yarn.lock'

      - name: Install Dependencies & Build
        working-directory: ./client
        env:
          NEXT_PUBLIC_CDN_DOMAIN: ${{ secrets.NEXT_PUBLIC_CDN_DOMAIN }}
          VIEW_DATA_FILE_PATH: ${{ secrets.VIEW_DATA_FILE_PATH }}
          VIEW_DATA_FLUSH_THRESHOLD: ${{ secrets.VIEW_DATA_FLUSH_THRESHOLD }}
          NEXT_PUBLIC_BACKEND_SERVER_BASE_URL: ${{ secrets.NEXT_PUBLIC_BACKEND_SERVER_BASE_URL }}
          NEXT_PUBLIC_FRONTEND_SERVER_BASE_URL: ${{ secrets.NEXT_PUBLIC_FRONTEND_SERVER_BASE_URL }}
          NEXT_PUBLIC_AMPLITUDE_API_KEY: ${{ secrets.NEXT_PUBLIC_AMPLITUDE_API_KEY }}
          NEXT_PUBLIC_IMAGE_S3_DOMAIN: ${{ secrets.NEXT_PUBLIC_IMAGE_S3_DOMAIN }}
          NEXT_PUBLIC_IMAGE_CLOUDFRONT_DOMAIN: ${{ secrets.NEXT_PUBLIC_IMAGE_CLOUDFRONT_DOMAIN }}
          NEXT_PUBLIC_SENTRY_DSN: ${{ secrets.NEXT_PUBLIC_SENTRY_DSN }}
          SENTRY_AUTH_TOKEN: ${{ secrets.SENTRY_AUTH_TOKEN }}
        run: |
          echo "ğŸš§ Installing dependencies..."
          yarn install --frozen-lockfile

          echo "ğŸ—ï¸ Building Next.js..."
          yarn build

      - name: Compress Build Output Only
        working-directory: ./client
        run: |
          echo "ğŸ“¦ Compressing .next..."
          tar -czf next-build.tar.gz .next
          echo "âœ… Build file compressed: $(ls -lh next-build.tar.gz)"

      - name: Copy Build File to Root
        run: |
          cp ./client/next-build.tar.gz ./next-build.tar.gz
          echo "âœ… Build file copied to root: $(ls -lh ./next-build.tar.gz)"

      - name: Upload Build to EC2
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.SSH_DEV_HOST }}
          username: ${{ secrets.SSH_DEV_USERNAME }}
          key: ${{ secrets.SSH_DEV_KEY }}
          port: ${{ secrets.SSH_DEV_PORT }}
          source: 'next-build.tar.gz'
          target: ${{ secrets.EC2_DEV_DEPLOY_DIR }}

      - name: Deploy on EC2
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SSH_DEV_HOST }}
          username: ${{ secrets.SSH_DEV_USERNAME }}
          key: ${{ secrets.SSH_DEV_KEY }}
          port: ${{ secrets.SSH_DEV_PORT }}
          script: |
            set -e
            set -o pipefail
            trap 'echo "âŒ ë°°í¬ ì‹¤íŒ¨: ë¼ì¸ $LINENOì—ì„œ ì—ëŸ¬ ë°œìƒ"; exit 1' ERR

            cd ${{ secrets.EC2_DEV_DEPLOY_DIR }} || {
              echo "âŒ ë°°í¬ ë””ë ‰í† ë¦¬ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ${{ secrets.EC2_DEV_DEPLOY_DIR }}"
              exit 1
            }

            echo "ğŸ”„ Pulling latest code from Git..."
            # git ì¶©ëŒ ë°©ì§€ë¥¼ ìœ„í•œ ê°•ì œ ë®ì–´ì“°ê¸°
            git fetch origin develop
            git reset --hard origin/develop

            echo "ğŸ“‚ Checking build file..."
            if [ ! -f next-build.tar.gz ]; then
              echo "âŒ Build file not found. Listing files:"
              ls -la
              exit 1
            fi
            echo "âœ… Build file found: $(ls -lh next-build.tar.gz)"

            echo "ğŸ“‚ Extracting .next build..."
            rm -rf .next || sudo rm -rf .next
            tar -xzf next-build.tar.gz
            rm next-build.tar.gz

            echo "ğŸ“¥ Setting up Node environment..."
            export NVM_DIR="$HOME/.nvm"
            [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
            [ -s "$NVM_DIR/bash_completion" ] && \. "$NVM_DIR/bash_completion"
            nvm use 22.16.0

            if ! command -v yarn &> /dev/null; then
              echo "âš ï¸  yarnì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. npmìœ¼ë¡œ yarn ì„¤ì¹˜ ì¤‘..."
              npm install -g yarn
            fi

            if ! command -v pm2 &> /dev/null; then
              echo "âš ï¸  PM2ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. npmìœ¼ë¡œ PM2 ì„¤ì¹˜ ì¤‘..."
              npm install -g pm2
            fi

            yarn install --frozen-lockfile

            echo "ğŸš€ Restarting PM2..."
            pm2 update 2>/dev/null || true
            pm2 reload ecosystem.config.js --env development --update-env || \
            pm2 start ecosystem.config.js --env development

            echo "âœ… ë°°í¬ê°€ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!"
