name: frontend-dev-deploy

on:
  push:
    branches:
      - develop
    paths:
      - 'client/**'

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: development

    steps:
      - name: Checkout Source
        uses: actions/checkout@v5

      - name: Setup Node.js
        uses: actions/setup-node@v5
        with:
          node-version: '22.16.0'
          cache: 'yarn'

      - name: Install Dependencies & Build
        working-directory: ./client
        env:
          NEXT_PUBLIC_CDN_DOMAIN: ${{ secrets.NEXT_PUBLIC_CDN_DOMAIN }}
          VIEW_DATA_FILE_PATH: ${{ secrets.VIEW_DATA_FILE_PATH }}
          VIEW_DATA_FLUSH_THRESHOLD: ${{ secrets.VIEW_DATA_FLUSH_THRESHOLD }}
          NEXT_PUBLIC_BACKEND_SERVER_BASE_URL: ${{ secrets.NEXT_PUBLIC_BACKEND_SERVER_BASE_URL }}
          NEXT_PUBLIC_FRONTEND_SERVER_BASE_URL: ${{ secrets.NEXT_PUBLIC_FRONTEND_SERVER_BASE_URL }}
          NEXT_PUBLIC_AMPLITUDE_API_KEY: ${{ secrets.NEXT_PUBLIC_AMPLITUDE_API_KEY }}
          NEXT_PUBLIC_IMAGE_S3_DOMAIN: ${{ secrets.NEXT_PUBLIC_IMAGE_S3_DOMAIN }}
          NEXT_PUBLIC_IMAGE_CLOUDFRONT_DOMAIN: ${{ secrets.NEXT_PUBLIC_IMAGE_CLOUDFRONT_DOMAIN }}
          NEXT_PUBLIC_SENTRY_DSN: ${{ secrets.NEXT_PUBLIC_SENTRY_DSN }}
          SENTRY_AUTH_TOKEN: ${{ secrets.SENTRY_AUTH_TOKEN }}
        run: |
          echo "ðŸš§ Installing dependencies..."
          yarn install --frozen-lockfile

          echo "ðŸ—ï¸ Building Next.js..."
          yarn build

      - name: Compress Build Output Only
        working-directory: ./client
        run: |
          echo "ðŸ“¦ Compressing .next..."
          tar -czf next-build.tar.gz .next

      - name: Transfer Build to EC2
        working-directory: ./client
        run: |
          echo "ðŸ”‘ Setting up SSH key..."
          printf "%s\n" "${{ secrets.SSH_DEV_KEY }}" > private_key.pem
          sed -i 's/\r$//' private_key.pem
          chmod 600 private_key.pem

          echo "ðŸš€ Sending .next build via SCP..."
          scp -o StrictHostKeyChecking=no -i private_key.pem -P ${{ secrets.SSH_DEV_PORT }} \
            next-build.tar.gz \
            ${{ secrets.SSH_DEV_USERNAME }}@${{ secrets.SSH_DEV_HOST }}:${{ secrets.EC2_DEV_DEPLOY_DIR }}

          echo "ðŸ§¹ Cleaning up..."
          rm private_key.pem

      - name: Deploy on EC2
        working-directory: ./client
        run: |
          echo "ðŸ”‘ Setting up SSH key..."
          printf "%s\n" "${{ secrets.SSH_DEV_KEY }}" > private_key.pem
          sed -i 's/\r$//' private_key.pem
          chmod 600 private_key.pem

          echo "ðŸ“œ Creating deployment script..."
          cat <<'EOF' > deploy_script.sh
            set -e
            set -o pipefail
            trap 'echo "âŒ ë°°í¬ ì‹¤íŒ¨: ë¼ì¸ $LINENOì—ì„œ ì—ëŸ¬ ë°œìƒ"; exit 1' ERR
            
            cd ${{ secrets.EC2_DEV_DEPLOY_DIR }} || {
              echo "âŒ ë°°í¬ ë””ë ‰í† ë¦¬ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ${{ secrets.EC2_DEV_DEPLOY_DIR }}"
              exit 1
            }

            echo "ðŸ”„ Pulling latest code from Git..."
            # git ì¶©ëŒ ë°©ì§€ë¥¼ ìœ„í•œ ê°•ì œ ë®ì–´ì“°ê¸°
            git fetch origin develop
            git reset --hard origin/develop
            
            echo "ðŸ“‚ Extracting .next build..."
            rm -rf .next
            tar -xzf next-build.tar.gz
            rm next-build.tar.gz

            echo "ðŸ“¥ Setting up Node environment..."
            export NVM_DIR="$HOME/.nvm"
            [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
            [ -s "$NVM_DIR/bash_completion" ] && \. "$NVM_DIR/bash_completion"
            nvm use 22.16.0

            if ! command -v yarn &> /dev/null; then
              echo "âš ï¸  yarnì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. npmìœ¼ë¡œ yarn ì„¤ì¹˜ ì¤‘..."
              npm install -g yarn
            fi

            if ! command -v pm2 &> /dev/null; then
              echo "âš ï¸  PM2ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. npmìœ¼ë¡œ PM2 ì„¤ì¹˜ ì¤‘..."
              npm install -g pm2
            fi
            
            yarn install --frozen-lockfile

            echo "ðŸš€ Restarting PM2..."
            pm2 update 2>/dev/null || true
            pm2 reload ecosystem.config.js --env development --update-env || \
            pm2 start ecosystem.config.js --env development
            
            echo "âœ… Deployment Complete!"
          EOF

          echo "ðŸš€ Executing deployment on EC2..."
          if ! ssh -o StrictHostKeyChecking=no -i private_key.pem -p ${{ secrets.SSH_DEV_PORT }} \
            ${{ secrets.SSH_DEV_USERNAME }}@${{ secrets.SSH_DEV_HOST }} \
            "bash -s" < deploy_script.sh; then
            echo "âŒ EC2 ë°°í¬ ì‹¤íŒ¨!"
            rm private_key.pem deploy_script.sh
            exit 1
          fi

          rm private_key.pem deploy_script.sh
          echo "âœ… ë°°í¬ê°€ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!"
